<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Ropa a Discord</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://i.imgur.com/HUhIujV.jpeg" type="image/jpeg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para transiciones suaves */
        #notification, .preview-item {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Ocultar el input de archivo por defecto */
        #fileUpload {
            display: none;
        }
        /* Prevenir la selección y el arrastre de imágenes no deseadas */
        img, video {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Sintaxis estándar */
        }
        /* Estilo para el texto truncado en vistas previas */
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8 px-4">

    <div class="w-full max-w-lg mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <div class="flex flex-col items-center text-center mb-8">
                <img id="sendUploadButton" src="https://i.imgur.com/y5WqBp1.jpeg" alt="Enviar como Subido" title="Enviar como Subido" class="w-20 h-20 rounded-full mb-4 shadow-md object-cover cursor-pointer hover:scale-110 transition-transform duration-300">
                <h1 class="text-3xl font-bold text-gray-800">Clothing Bot</h1>
                <p class="text-gray-500">Envía prendas a tu canal de Discord.</p>
            </div>
            
            <div class="mb-4">
                <label for="message" class="sr-only">Mensaje</label>
                <textarea 
                    id="message" 
                    rows="4" 
                    class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:outline-none text-gray-700 placeholder-gray-400 resize-none transition-colors"
                    placeholder="Describe la prenda o pega un enlace de Roblox..."
                ></textarea>
            </div>

            <div class="mb-4">
                <label for="fileUpload" class="w-full cursor-pointer bg-white border-2 border-dashed border-gray-300 hover:border-gray-400 hover:bg-gray-50 text-gray-500 font-semibold py-4 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800 transition-colors duration-300 flex flex-col items-center justify-center text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    <span>Subir archivo(s)</span>
                </label>
                <input type="file" id="fileUpload" accept="image/*,video/*,audio/*" multiple>
            </div>

            <!-- Contenedor para múltiples vistas previas -->
            <div id="previewContainer" class="mb-2 hidden flex flex-wrap gap-4">
                <!-- Las vistas previas de los archivos se insertarán aquí -->
            </div>
            
            <!-- Indicador de tamaño total -->
            <div id="sizeIndicator" class="hidden text-sm text-gray-600 text-right mb-4"></div>
            
            <!-- Botones de envío -->
            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="sendShirtButton" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center shadow-sm">
                        <span class="button-text">Enviar como Camisa</span>
                    </button>
                    <button id="sendPantsButton" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center shadow-sm">
                        <span class="button-text">Enviar como Pantalón</span>
                    </button>
                </div>
            </div>

             <div id="loadingIndicator" class="hidden mt-6 flex items-center justify-center text-gray-500">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Enviando a Discord...</span>
            </div>
        </div>
        
        <div id="notification" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const messageTextarea = document.getElementById('message');
        const fileUpload = document.getElementById('fileUpload');
        const previewContainer = document.getElementById('previewContainer');
        const sizeIndicator = document.getElementById('sizeIndicator');
        const sendShirtButton = document.getElementById('sendShirtButton');
        const sendPantsButton = document.getElementById('sendPantsButton');
        const sendUploadButton = document.getElementById('sendUploadButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const notification = document.getElementById('notification');
        
        // --- Webhook Configuration ---
        const shirtWebhookURL = 'https://discord.com/api/webhooks/1388257791088656394/CzyDrlhJBRaZ-B2Frt2Ca2Lt67_t2WoXJQBI52mLDGwrRuaZOzYFRzQOgJMelFFwRu6l';
        const pantsWebhookURL = 'https://discord.com/api/webhooks/1388257888077611058/Vbcsa7p8SpUEmYKPw6EzDQ0s4cLrqUHSOuLurc8END_5XFL_w-yev9NZctrIPoEydws0';
        const uploadWebhookURL = 'https://discord.com/api/webhooks/1388243649837666569/H25jj5XHMA_zcP7KbmPW3R1pImYJICakNVM4XI9wpiW63hMIoX4MV2_E51Kvb-U5ckrh';
        const botUsername = 'Clothing Bot';
        const botAvatarUrl = 'https://i.imgur.com/y5WqBp1.jpeg';

        // --- State and Constants ---
        let isSending = false;
        let selectedFiles = []; 
        let currentTotalSize = 0;
        // CORREGIDO: Límite de tamaño actualizado a 10MB
        const MAX_TOTAL_SIZE = 10 * 1024 * 1024;

        // --- File Handling ---
        fileUpload.addEventListener('change', function(event) {
            const newFiles = Array.from(event.target.files);
            
            for (const file of newFiles) {
                 if (selectedFiles.length >= 10) {
                    showNotification('Puedes subir un máximo de 10 archivos.', true);
                    break; 
                }
                
                if (currentTotalSize + file.size > MAX_TOTAL_SIZE) {
                    const fileName = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
                    showNotification(`No se puede añadir "${fileName}". El tamaño total superaría los 10 MB.`, true);
                    continue;
                }

                selectedFiles.push({
                    id: Date.now() + Math.random(),
                    file: file
                });
                currentTotalSize += file.size;
            }

            renderPreviews();
            fileUpload.value = '';
        });

        // CORREGIDO: Lógica de renderizado para preservar el orden
        function renderPreviews() {
            previewContainer.innerHTML = ''; 

            if (selectedFiles.length > 0) {
                previewContainer.classList.remove('hidden');
                sizeIndicator.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
                sizeIndicator.classList.add('hidden');
            }

            const totalMB = (currentTotalSize / (1024 * 1024)).toFixed(2);
            const maxMB = (MAX_TOTAL_SIZE / (1024 * 1024)).toFixed(0);
            sizeIndicator.textContent = `Tamaño total: ${totalMB} MB / ${maxMB} MB`;
            sizeIndicator.classList.toggle('text-red-600', currentTotalSize > MAX_TOTAL_SIZE);


            // 1. Crear todos los contenedores de vista previa sincrónicamente para mantener el orden
            selectedFiles.forEach(fileWrapper => {
                const previewWrapper = document.createElement('div');
                previewWrapper.id = `preview-${fileWrapper.id}`;
                previewWrapper.className = 'preview-item relative w-24 h-24 flex items-center justify-center bg-gray-100 rounded-lg border border-gray-200 overflow-hidden';
                previewContainer.appendChild(previewWrapper);
            });

            // 2. Poblar los contenedores asincrónicamente
            selectedFiles.forEach(fileWrapper => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Encontrar el contenedor correcto que ya fue creado
                    const targetWrapper = document.getElementById(`preview-${fileWrapper.id}`);
                    if (!targetWrapper) return; // Salir si el elemento fue eliminado antes de cargar

                    const file = fileWrapper.file;
                    const fileType = file.type;
                    const objectURL = e.target.result;

                    let mediaElement;
                    let iconHTML = '';

                    if (fileType.startsWith('image/')) {
                        mediaElement = document.createElement('img');
                        mediaElement.className = 'w-full h-full object-cover';
                    } else if (fileType.startsWith('video/')) {
                        mediaElement = document.createElement('video');
                        mediaElement.className = 'w-full h-full object-cover bg-black';
                        mediaElement.autoplay = true;
                        mediaElement.muted = true;
                        mediaElement.loop = true;
                        mediaElement.playsInline = true;
                    } else if (fileType.startsWith('audio/')) {
                        iconHTML = `
                            <div class="flex flex-col items-center justify-center text-gray-500 p-1 text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mb-1"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                                <span class="text-xs truncate-text w-full">${file.name}</span>
                            </div>`;
                    } else {
                        iconHTML = `
                            <div class="flex flex-col items-center justify-center text-gray-500 p-1 text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mb-1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                                <span class="text-xs truncate-text w-full">${file.name}</span>
                            </div>`;
                    }
                    
                    if (iconHTML) {
                       targetWrapper.innerHTML = iconHTML;
                    }

                    if (mediaElement) {
                        mediaElement.src = objectURL;
                        targetWrapper.appendChild(mediaElement);
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'Quitar archivo';
                    removeBtn.className = 'absolute top-1 right-1 bg-black/60 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-lg hover:bg-black/80 transition-colors z-10';
                    removeBtn.onclick = () => removeFile(fileWrapper.id);
                    
                    targetWrapper.appendChild(removeBtn);
                }
                reader.readAsDataURL(fileWrapper.file);
            });
        }
        
        function removeFile(id) {
            const fileIndex = selectedFiles.findIndex(wrapper => wrapper.id === id);
            if (fileIndex > -1) {
                currentTotalSize -= selectedFiles[fileIndex].file.size;
                selectedFiles.splice(fileIndex, 1);
                renderPreviews();
            }
        }

        function clearAllFiles() {
            selectedFiles = [];
            currentTotalSize = 0;
            fileUpload.value = '';
            renderPreviews();
        }

        // --- Sending Logic ---
        sendShirtButton.addEventListener('click', () => sendMessage('CAMISA'));
        sendPantsButton.addEventListener('click', () => sendMessage('PANTALON'));
        sendUploadButton.addEventListener('click', () => sendMessage('SUBIDO')); 

        async function sendMessage(tag) {
            if (isSending) return;

            const originalMessage = messageTextarea.value.trim();
            if (!originalMessage && selectedFiles.length === 0) {
                showNotification('Debes escribir un mensaje o subir al menos un archivo.', true);
                return;
            }

            if (currentTotalSize > MAX_TOTAL_SIZE) {
                showNotification('El tamaño total de los archivos supera los 10 MB. Por favor, elimina algunos.', true);
                return;
            }
            
            setLoading(true);
            
            let processedMessage = originalMessage;
            const robloxUrlRegex = /(https?:\/\/www\.roblox\.com\/catalog\/\d+)/;
            const match = originalMessage.match(robloxUrlRegex);
            if (match && match[0]) {
                processedMessage = `<${match[0]}>`; 
            }
            
            let targetWebhookURL;
            let finalTag;

            if (tag === 'CAMISA') {
                targetWebhookURL = shirtWebhookURL;
                finalTag = '> ## **Camisa** [ 🥼 ]';
            } else if (tag === 'PANTALON') {
                targetWebhookURL = pantsWebhookURL;
                finalTag = '> ## **Pantalon** [ 👖 ]';
            } else if (tag === 'SUBIDO') {
                targetWebhookURL = uploadWebhookURL;
                finalTag = '> ## **Subido** [ 📤 ]';
            }
            
            let messagePart = processedMessage ? ` ${processedMessage}` : '';
            let finalContent = `${finalTag}${messagePart}`;

            if (selectedFiles.length > 0 && !processedMessage) {
                finalContent += "\n\u200b";
            }

            const formData = new FormData();
            const payload = {
                content: finalContent,
                username: botUsername,
                avatar_url: botAvatarUrl
            };
            
            formData.append('payload_json', JSON.stringify(payload));
            
            selectedFiles.forEach((fileWrapper, index) => {
                formData.append(`file${index}`, fileWrapper.file);
            });

            try {
                const response = await fetch(targetWebhookURL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    showNotification('¡Enviado con éxito!');
                    messageTextarea.value = '';
                    clearAllFiles();
                } else {
                    const errorData = await response.json();
                    console.error('Discord Error:', errorData);
                    let errorMessage = `Error: ${response.status}.`;
                    if (errorData.message) errorMessage += ` ${errorData.message}`;
                    showNotification(errorMessage, true);
                }
            } catch (error) {
                console.error('Network Error:', error);
                showNotification('Error de conexión. Revisa la consola.', true);
            } finally {
                setLoading(false);
            }
        }
        
        // --- UI Helper Functions ---
        function setLoading(isLoading) {
            isSending = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            
            [sendShirtButton, sendPantsButton, sendUploadButton].forEach(btn => {
                btn.disabled = isLoading;
                btn.classList.toggle('opacity-50', isLoading);
                btn.classList.toggle('pointer-events-none', isLoading);
            });
        }

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-2 transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-2');
                notification.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }
    </script>
</body>
</html>
